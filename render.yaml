databases:
  - name: alma-db
    plan: free
    databaseName: alma
    ipAllowList: []  # agrega IPs si las necesitás

services:
  - type: web
    name: almaconecta-1
    env: docker
    plan: free

    dockerfilePath: ./Dockerfile
    healthCheckPath: /

    # Disco persistente para uploads (storage)
    disk:
      name: storage
      mountPath: /var/www/html/storage
      sizeGB: 1

    # Ejecuta migraciones en el "release phase" antes de arrancar la app
    releaseCommand: >
      bash -lc '
        set -e

        echo "==> Clearing Laravel caches"
        php artisan optimize:clear || true

        echo "==> Waiting for database to be ready..."
        for i in {1..30}; do
          if php artisan migrate:status >/dev/null 2>&1; then
            echo "DB is reachable."
            break
          fi
          echo "DB not ready, retrying ($i/30)..."
          sleep 2
        done

        echo "==> Running migrations"
        php artisan migrate --force

        echo "==> Storage symlink"
        echo "==> Ensuring storage directories"
        mkdir -p storage/app/public storage/framework/cache/data storage/framework/sessions storage/framework/views storage/logs bootstrap/cache
        chown -R www-data:www-data storage bootstrap/cache || true
        chmod -R 775 storage bootstrap/cache || true
        php artisan storage:link || true

        echo "==> Rebuilding caches"
        php artisan config:cache
        php artisan route:clear
        php artisan view:cache
      '

    envVars:
      - key: APP_ENV
        value: production

      # ⚠️ Dejalo en "true" sólo mientras estás depurando errores 500.
      - key: APP_DEBUG
        value: "true"

      # Setealo en el dashboard (no en git). Formato típico: base64:XXXXXXXX
      - key: APP_KEY
        sync: false

      # Útil para generar URLs absolutas correctas
      - key: APP_URL
        value: https://almaconecta-1.onrender.com

      # Logs de Laravel a stderr (aparecen en Logs de Render)
      - key: LOG_CHANNEL
        value: errorlog
      - key: LOG_LEVEL
        value: debug

      # Conexión a la DB administrada por Render
      - key: DB_CONNECTION
        value: pgsql
      - key: DB_HOST
        fromDatabase:
          name: alma-db
          property: host
      - key: DB_PORT
        fromDatabase:
          name: alma-db
          property: port
      - key: DB_DATABASE
        fromDatabase:
          name: alma-db
          property: database
      - key: DB_USERNAME
        fromDatabase:
          name: alma-db
          property: user
      - key: DB_PASSWORD
        fromDatabase:
          name: alma-db
          property: password
