databases:
  - name: alma-db
    plan: free
    databaseName: alma
    ipAllowList: []

services:
  - type: web
    name: almaconecta-1
    env: docker
    plan: free
    dockerfilePath: ./Dockerfile

    # Único lugar donde corren las migraciones
    releaseCommand: >
      bash -lc '
        echo "==> Waiting for DB...";
        for i in {1..30}; do
          php artisan migrate:status >/dev/null 2>&1 && break || true;
          echo "DB not ready, retrying ($i/30)..."; sleep 2;
        done;

        php artisan optimize:clear || true;

        if [ "${RUN_FRESH:-0}" = "1" ]; then
          echo "==> RUN_FRESH=1 → php artisan migrate:fresh --force";
          php artisan migrate:fresh --force --no-interaction;
          php artisan db:seed --force || true;
        else
          echo "==> RUN_FRESH!=1 → php artisan migrate --force";
          php artisan migrate --force --no-interaction;
        fi

        php artisan storage:link || true;
      '

    # Healthcheck para que Render espere a que responda
    healthCheckPath: /

    envVars:
      - key: APP_ENV
        value: production
      - key: APP_DEBUG
        value: false
      - key: APP_KEY
        sync: false

      # Conexión a la DB de Render
      - key: DB_CONNECTION
        value: pgsql
      - key: DB_HOST
        fromDatabase:
          name: alma-db
          property: host
      - key: DB_PORT
        fromDatabase:
          name: alma-db
          property: port
      - key: DB_DATABASE
        fromDatabase:
          name: alma-db
          property: database
      - key: DB_USERNAME
        fromDatabase:
          name: alma-db
          property: user
      - key: DB_PASSWORD
        fromDatabase:
          name: alma-db
          property: password

      # Actívalo SOLO para el reset inicial; luego ponlo en "0" o elimínalo
      - key: RUN_FRESH
        value: "1"
